<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>DeclarativeForms</TITLE>
<META content="text/html; charset=Windows-1252" http-equiv="Content-Type">
<META name="keywords" content="OneScript, DeclarativeForms, 1С">
<LINK rel="stylesheet" type="text/css" href="mainstyle.css">
</HEAD>
<BODY id=bodyID class=dtBODY>
<DIV id=nsbanner>
<DIV id=bannerrow1>
<TABLE class=bannerparthead cellSpacing=0>
  <TBODY>
  <TR id=hdr>
    <TD class=runninghead></TD>
    <TD class=product></TD></TR></TBODY></TABLE></DIV>
<DIV id=TitleRow>
<H1 class=dtH1>Библиотека DeclarativeForms</H1></DIV></DIV>
<DIV id=nstext>
<br>
<H3 class=dtH3>Назначение</H3>
<br>
<P>Декларативные формы задумывались как десктопное приложение на базе веб-технологий, со всеми возможностями движка Chrome. 
Изначально требования к приложению ставились следующие:</P>
<DIV style="margin-left: 40px;">
	<li>Нужна программа с браузером в окне, но не браузер с нашей программой.</li>
	<li>Нужен простой код создания и управления элементами и простая обработка событий. Что то вроде 
<PRE class=code>
Кнопка1 = ДФ.Кнопка();
Кнопка1.Родитель = Форма1;
Кнопка1.Текст = "Кнопка";
Кнопка1.Нажатие = ДФ.Действие(ЭтотОбъект, "Кнопка1_Нажатие");
</PRE>
	</li>
	<li>Запуск на любой платформе где можно запустить браузер Chrome.</li>
	<li>Избежать необходимости изучать дополнительные фреймворки.</li>
	<li>Приложение должно работать в фоне, запускаться при старте системы и оффлайн.</li>
	<li>Версия браузера определяется пользователем, а не системой.</li>
	<li>Возможность создания меню, нескольких окон, иконки в трее (менюбаре), управление ими.</li>
	<li>Возможность режима kiosk-mode (как в десктопных играх) и для создания презентаций в том числе.</li>
</DIV>
<P>В первую очередь это инструмент в помощь разработчикам на языке 1С. Используются два движка - 
<A href="https://oscript.io/" target="_blank">OneScript</A> и <A href="https://nwjs.io/" target="_blank">NW.JS</A>.</P>
<P><B>OneScript</B> повторяет синтаксис 1С, поэтому тем, кто с ним знаком дополнительно ничего изучать не нужно.</P>
<P><B>NW.JS</B> обеспечивает кроссплатформенность, так как может создать окно программы с браузером в этом окне. Его изучать не нужно, 
механизм его работы и взаимодействия со сценарием скрыт внутри библиотеки декларативных форм. <B>NW.JS</B> находится в активной разработке 
и часто выходят новые версии с обновленным движком <B>Chromium</B>. Вы сможете скачать <B>NW.JS</B> выбрав версию и платфому.</P>
<br>
<H3 class=dtH3>Требования к каталогу Вашей программы.</H3>
<br>
<P>Минимальные требования к устройству каталога Вашей программы при первом запуске показаны на рисунке ниже.</P>
<style>img { border: 3px solid #808080; }</style>
<IMG src="Intro1.jpg"></IMG>
<br>
<P><span style="color: #ff0000;"><B>Важно:</B> в каталоге <B>Классы</B> должна лежать библиотека TCP сервера <B>OneScriptClientServer.dll</B>.</span></P>
<P>Без TCP сервера невозможна связь формы с нашим сценарием. Я использовал версию <B>3.0.1.0</B> и она будет в релизе декларативных форм на гитхабе.</P>
<P>Имя стартового сценария не регламентируется. В этой справке стартовый сценарий будет называться <B>Главный.os</B>.</P>
<P>Содержимое файла <B>Главный.os</B> следующее:</P>
<PRE class=code>
ПодключитьВнешнююКомпоненту("ВашКаталогНаДиске\DeclarativeForms.dll");
ДФ = Новый ДекларативныеФормы();
ДФ.nwПуть = "C:\222\nwjs\nw.exe";
ДФ.oscriptПуть = "C:\Program Files\OneScript\bin\oscript.exe";

Форма1 = ДФ.Форма;
Форма1.Открыть();
</PRE>
<P>Пути указаны с моего компьютера.</P>
<P>При запуске программа проверит наличие необходимых файлов и допишет их, с содержимым по умолчанию, в каталог. В итоге получится так:</P>
<style>img { border: 3px solid #808080; }</style>
<IMG src="Intro2.jpg"></IMG>
<P>Можно поместить движки <B>OneScript</B> и <B>NW.JS</B> в нашем каталоге и не указывать в сценарии пути до них. Программа по умолчанию будет искать их 
в каталогах <B>oscript</B> и <B>nwjs</B>. Код сценария сократится до:</P>
<PRE class=code>
ПодключитьВнешнююКомпоненту("ВашКаталогНаДиске\DeclarativeForms.dll");
ДФ = Новый ДекларативныеФормы();

Форма1 = ДФ.Форма;
Форма1.Открыть();
</PRE>
<P>И каталог программы будет такой:</P>
<style>img { border: 3px solid #808080; }</style>
<IMG src="Intro3.jpg"></IMG>
<P></P>
<br>
<H3 class=dtH3>Подключение библиотеки и создание объекта ДекларативныеФормы.</H3>
<br>
<P>Подключить библиотеку можно так:</P>
<PRE class=code>
ПодключитьВнешнююКомпоненту("ВашКаталогНаДиске\DeclarativeForms.dll");
ДФ = Новый ДекларативныеФормы();
</PRE>
<P>При создании объекта ДекларативныеФормы автоматически выполнится метод <B>ДФ.ЗагрузитьСценарии(".\")</B> и подключатся сценарии находящиеся в 
подкаталогах <B>Классы</B> и <B>Модули</B>. В подключенных сценариях будет доступна структура под именем <B>ОбщаяСтруктура</B>. И у <B>ОбщаяСтруктура</B> 
будет свойство с именем <B>ДФ</B>. Так что Вы можете в подключенном сценарии сразу обратиться к объекту <B>ДекларативныеФормы</B> так:</P>
<PRE class=code>
Сообщить("из сценария ОбщаяСтруктура.ДФ = " + ОбщаяСтруктура.ДФ);
</PRE>
<br>
<H3 class=dtH3>Закрытие программы.</H3>
<br>
<P>После запуска стартового сценария откроется окно консоли и затем окно программы. Взаимодействовать они будут через запущенный фоновым заданием TCP сервер. 
Запуск TCP сервера производится файлом <B>startserver.os</B>. Файл сервера <B>server</B> не должен иметь расширения. Корректное закрытие всех запущенных 
модулей - это закрытие окна программы. Это вызовет завершение работы и <B>NW.JS</B>  и фонового TCP сервера и окна консоли.</P>
<P>Если закрыть только окно консоли это вызовет и завершение фонового TCP сервера, но окно программы останется открытым и может выдать сообщение о потере связи с сервером, 
после чего может автоматически закрыться. Возможно закрытия и не произойдет, зависит от кода программы. Следующий запуск стартового сценария будет успешным только 
после закрытия окна программы.</P>
<P>Избежать появление окна консоли совсем поможет разработка <A href="https://github.com/ahyahy/OneScriptNoConsole" target="_blank">Запуск сценариев OneScript без окна консоли</A>.</P>
<P></P>
<br>
<H3 class=dtH3>Как происходит обработка событий.</H3>
<br>
<P>Декларативные формы выполнены в парадигме событийно-ориентированного программирования. С одной стороны у нас движок <B>NW.JS</B>, который по нашему плану 
создал окно с движком браузера <B>Chromium</B> в пределах окна. С другой стороны сценарий, работающий на движке <B>OneScript</B>. Связь между ними происходит 
посредством <B>TCP сервера</B>, запущенного фоновым процессом из сценария. При возникновении в форме события выполняется соответствующая функция из 
скрипта <B>main.js</B>. Функция формирует <B>HTTP-запрос</B> для <B>TCP сервера</B>. <B>TCP сервер</B> анализирует этот запрос, находит указанный 
обработчик в сценарии и выполняет его. Затем высылает клиенту ответ. В этом ответе в виде строки собраны все действия возникшие во время выполнения обработчика. 
Действия эти представлены именами функций с параметрами. Функции разделены точкой с запятой. Получив в ответ на <B>HTTP-запрос</B> строку с перечнем функций 
скрипт <B>main.js</B> выполняет их, что вызывает изменения в форме.</P>
<P>Строка ответа сервера может быть просмотрена в любое время, она доступна в свойстве 
<B>ДекларативныеФормы.СтрокаФункций&nbsp;(DeclarativeForms.FunctionString)</B>. И её можно изменить, повлияв на ответ сервера по своему усмотрению.</P>
<P>Из всего этого ясно, что изменять форму в ответ на возникающие события мы можем только во время выполнения <B>HTTP-запроса</B>. Первый такой запрос 
производится при выполнении метода <B>Форма.Открыть&nbsp;(Form.Open)</B>. До его запуска идет код создания объектов формы, задания свойств. Эти действия 
записываются в свойство <B>ДекларативныеФормы.СтрокаФункций&nbsp;(DeclarativeForms.FunctionString)</B>. С запуском метода <B>Форма.Открыть&nbsp;(Form.Open)</B> 
<B>NW.JS</B> формирует окно и срабатывает событие загрузки страницы <B>index.html</B>. В этом событии посылается первый запрос на сервер. Сервер в ответе высылает 
строку <B>ДекларативныеФормы.СтрокаФункций&nbsp;(DeclarativeForms.FunctionString)</B> функции из которой выполняются друг за другом. Создаются объекты формы и 
устанавливаются их свойства.</P>
<P>Мы обходимся без веб-сервера, но при этом не можем изменять состояние формы непосредственно при каждом атомарном изменении свойств объектов в сценарии. 
Можно только пакетом получить сделанные изменения и только в пределах выполнения обработчика события. Сервер закрывает соединение после отсылки ответа 
клиенту, иначе <B>HTTP-запрос</B> не будет получен клиентом. Было бы лучше иметь возможность влиять на состояние формы 
не только при обработке события, но и в произвольном месте сценария. Для этого средствами <B>NW.JS</B> в файле <B>main.js</B> создается <B>TCP&nbsp;клиент</B>. 
Он подключается к серверу и создает постоянный канал связи. При случайном или намеренном разрыве канал восстанавливается. По нему можно так же посылать 
форме имена функций с параметрами и делать это можно не в пределах обработчика события. Клиент будет доступен как <B>ДФ.ОбщаяСтруктура.Клиент</B>. 
 <PRE class=code>
ДФ.ОбщаяСтруктура.Клиент.ОтправитьСообщение(ДФ.ОбщаяСтруктура.КС.СообщениеТекст(
";setAttribute('" + Кнопка2.Имя + "', '" + "backgroundColor" + "', '" + "rgb(255, 255, 0)" + "')"));

или так:

Кнопка2.ЦветФона = ДФ.Цвет.Красный;
ДФ.ОбщаяСтруктура.Клиент.ОтправитьСообщение(ДФ.ОбщаяСтруктура.КС.СообщениеТекст(ДФ.СтрокаФункций));
</PRE>
</P>
<P>И клиент и переменная <B>КС</B> - это объекты библиотеки <B>OneScriptClientServer.dll</B>. Они доступны вот просто так сразу, без 
дополнительных объявлений во всех подключенных сценариях. Как это достигается Вы можете узнать ознакомившись с моей разработкой 
<A href="https://github.com/ahyahy/OneScriptIntegrator" target="_blank">Эффективное взаимодействия между сценариями проекта...</A>.</P>
<P> Есть ограничение - такое возможно только после выполнения метода <B>Форма.Открыть&nbsp;(Form.Open)</B>, потому что <B>ДФ.ОбщаяСтруктура.Клиент</B> и 
<B>ДФ.ОбщаяСтруктура.КС</B> доступны только после первого <B>HTTP-запроса</B> от загруженной формы.</P>
<P>Так как <B>TCP сервер</B> многопоточный выполнение событий будет происходить не в линейном порядке отправки <B>HTTP-запросов</B>. 
Оно будет зависеть от алгоритма работы сервера и выполнение строгой очередности здесь не наблюдается.</P>
<P></P>
<P></P>
<br>
<P>.</P>
</DIV></BODY></HTML>
